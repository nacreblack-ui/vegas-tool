<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>VEGAS å¼·æ—¥ç‰¹åŒ–ãƒ¢ãƒ¼ãƒ‰</title>
<style>
body{font-family:sans-serif;margin:20px}
button{padding:10px;margin:5px 0}
.big{font-size:22px;font-weight:bold}
.ok{color:#2e7d32;font-weight:bold}
.ng{color:#c62828;font-weight:bold}
pre{background:#f5f5f5;padding:10px;white-space:pre-wrap}
table{border-collapse:collapse;width:100%;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;font-size:12px}
</style>
</head>
<body>

<h2>VEGAS å¼·æ—¥ç‰¹åŒ–ãƒ¢ãƒ¼ãƒ‰</h2>

<label><input type="checkbox" id="lineFlag"> LINEç…½ã‚Šã‚ã‚Š</label>

<p>å‰æ—¥CSV</p>
<input type="file" id="yFile" accept=".csv">
<button onclick="analyzeDay()">åˆ¤å®š</button>

<hr>

<div id="dayResult" class="big"></div>
<div id="scoreDetail"></div>
<div id="predOut"></div>

<script>

const MAIN_AT=[
"ãƒ¢ãƒ³ã‚­ãƒ¼ã‚¿ãƒ¼ãƒ³V",
"æ±äº¬å–°ç¨®",
"ç”²é‰„åŸã®ã‚«ãƒãƒãƒª",
"ã‚¹ãƒã‚¹ãƒ­åŒ—æ–—ã®æ‹³",
"æ–°é¬¼æ­¦è€…"
];

function parseCSV(text){
  text=text.replace(/^\uFEFF/,"").replace(/\r/g,"");
  const lines=text.split("\n").filter(l=>l.trim());
  const delim=text.includes("\t")?"\t":",";
  return lines.map(l=>l.replace(/"/g,"").split(delim));
}

function toNum(v){
  const s=String(v||"").replace(/,/g,"").trim();
  return s?Number(s):0;
}

function normalize(rows){
  const header=rows[0];
  const iMachine=header.findIndex(h=>h.includes("æ©Ÿç¨®"));
  const iNo=header.findIndex(h=>h.includes("å°"));
  const iG=header.findIndex(h=>h.includes("G"));
  const iDiff=header.findIndex(h=>h.includes("å·®"));
  if(iNo<0||iDiff<0) return null;

  const out=[];
  for(let i=1;i<rows.length;i++){
    const r=rows[i];
    out.push({
      machine:r[iMachine],
      no:toNum(r[iNo]),
      g:toNum(r[iG]),
      diff:toNum(r[iDiff])
    });
  }
  return out;
}

async function analyzeDay(){

  const file=document.getElementById("yFile").files[0];
  if(!file){alert("CSVé¸æŠ");return;}

  const text=await file.text();
  const rows=parseCSV(text);
  const data=normalize(rows);
  if(!data){alert("åˆ—æ¤œå‡ºå¤±æ•—");return;}

  const mainOnly=data.filter(d=>
    MAIN_AT.some(at=>d.machine.includes(at))
  );

  const mainMachines=new Set(
    mainOnly.filter(d=>d.diff>0).map(d=>d.machine)
  );

  const mainCount=mainMachines.size;

  const avgMainDiff = mainOnly.length
    ? mainOnly.reduce((a,b)=>a+b.diff,0)/mainOnly.length
    : 0;

  const totalDiff = data.reduce((a,b)=>a+b.diff,0);

  let score=0;
  let detail="";

  if(mainCount>=3){ score+=2; detail+="ä¸»åŠ›3æ©Ÿç¨®ä»¥ä¸Š +2\n"; }
  if(avgMainDiff>=200){ score+=2; detail+="ä¸»åŠ›å¹³å‡+200ä»¥ä¸Š +2\n"; }
  if(totalDiff<=-50000){ score+=1; detail+="å‰æ—¥å¤§å›å +1\n"; }
  if(document.getElementById("lineFlag").checked){
    score+=1; detail+="LINEç…½ã‚Š +1\n";
  }

  document.getElementById("scoreDetail").textContent=
    "ã‚¹ã‚³ã‚¢: "+score+"\n"+detail;

  if(score>=4){
    document.getElementById("dayResult").innerHTML=
      "<span class='ok'>ğŸ”¥ å¼·æ—¥æ¿ƒåš â†’ å°äºˆæƒ³å®Ÿè¡Œ</span>";
    makePrediction(mainOnly);
  }else{
    document.getElementById("dayResult").innerHTML=
      "<span class='ng'>é€šå¸¸æ¿ƒåš â†’ è¦‹é€ã‚Šæ¨å¥¨</span>";
    document.getElementById("predOut").innerHTML="";
  }
}

function makePrediction(mainOnly){

  const strongSet=new Set(
    mainOnly.filter(d=>d.diff>=3000).map(d=>d.no)
  );

  let pred=mainOnly.map(d=>{
    let score=0;
    if(d.g>=3500&&d.diff<0) score+=8;
    if(strongSet.has(d.no-1)||strongSet.has(d.no+1)) score+=5;
    return {...d,score};
  });

  pred.sort((a,b)=>b.score-a.score);
  pred=pred.slice(0,10);

  let html="<table><tr><th>é †ä½</th><th>å°ç•ªå·</th><th>æ©Ÿç¨®</th><th>ã‚¹ã‚³ã‚¢</th></tr>";
  pred.forEach((p,i)=>{
    html+=`<tr><td>${i+1}</td><td>${p.no}</td><td>${p.machine}</td><td>${p.score}</td></tr>`;
  });
  html+="</table>";

  document.getElementById("predOut").innerHTML=html;
}

</script>

</body>
</html>
