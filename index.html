<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>VEGAS WEB SAFE v3</title>
<style>
body{font-family:sans-serif;margin:20px}
textarea{width:100%;height:150px;margin:10px 0;padding:10px}
button{padding:10px;margin:5px 0}
pre{background:#f5f5f5;padding:10px;white-space:pre-wrap}
.big{font-size:20px;font-weight:bold}
.ok{color:#2e7d32;font-weight:bold}
.ng{color:#c62828;font-weight:bold}
</style>
</head>
<body>

<h2>VEGAS WEB SAFE v3（強化版）</h2>

<p>前日データ</p>
<textarea id="yData"></textarea>
<button onclick="makePrediction()">予想作成</button>

<hr>

<p>当日データ</p>
<textarea id="tData"></textarea>
<button onclick="evaluate()">検証</button>

<hr>

<div id="result" class="big"></div>
<pre id="debug"></pre>
<pre id="output"></pre>

<script>

let prediction=[];

function cleanText(text){
  return text
    .replace(/^\uFEFF/, "") // BOM削除
    .replace(/"/g, "")       // ダブルクォーテーション削除
    .replace(/\r/g,"");
}

function detectDelimiter(text){
  if(text.includes("\t")) return "\t";
  return ",";
}

function splitLines(text){
  return text.split("\n").filter(l=>l.trim().length>0);
}

function parseTable(text){
  text=cleanText(text);
  const lines=splitLines(text);
  if(!lines.length) return {header:[],rows:[]};

  const delim=detectDelimiter(text);
  const rows=lines.map(l=>l.split(delim).map(c=>c.trim()));
  const header=rows[0];
  const body=rows.slice(1);

  return {header,rows:body,delim};
}

function findCol(header,words){
  for(let i=0;i<header.length;i++){
    for(const w of words){
      if(header[i].includes(w)) return i;
    }
  }
  return -1;
}

function toNum(v){
  const s=String(v||"").replace(/,/g,"").trim();
  if(!s) return null;
  const n=Number(s);
  return Number.isFinite(n)?n:null;
}

function normalize(text){
  const {header,rows,delim}=parseTable(text);

  const debug=document.getElementById("debug");
  debug.textContent="ヘッダー検出: "+header.join(" | ")+"\n";

  if(!header.length){
    return {ok:false,why:"ヘッダーなし"};
  }

  const iNo=findCol(header,["台番号","台番"]);
  const iDiff=findCol(header,["差枚"]);
  const iMachine=findCol(header,["機種名","機種"]);
  const iG=findCol(header,["G数","G"]);

  debug.textContent +=
    "列位置: 台="+iNo+
    " 差枚="+iDiff+
    " 機種="+iMachine+
    " G="+iG+"\n";

  if(iNo<0 || iDiff<0){
    return {ok:false,why:"台番号または差枚列が見つからない"};
  }

  const out=[];
  for(const r of rows){
    const no=toNum(r[iNo]);
    const diff=toNum(r[iDiff])??0;
    const g=iG>=0?(toNum(r[iG])??0):0;
    const machine=iMachine>=0?r[iMachine]:"";

    if(no==null) continue;
    out.push({no,diff,g,machine});
  }

  return {ok:true,data:out};
}

function makePrediction(){
  const text=document.getElementById("yData").value;
  const norm=normalize(text);

  if(!norm.ok){
    document.getElementById("result").innerHTML="<span class='ng'>予想失敗</span>";
    document.getElementById("debug").textContent+=norm.why;
    return;
  }

  prediction=norm.data
    .map(x=>{
      const dip=(x.g>=2000 && x.diff<0)?Math.abs(x.diff):0;
      return {...x,score:dip};
    })
    .sort((a,b)=>b.score-a.score)
    .slice(0,15);

  document.getElementById("result").innerHTML="<span class='ok'>予想OK</span>";
  document.getElementById("output").textContent=
    "予想台: "+prediction.map(p=>p.no).join(", ");
}

function evaluate(){
  if(!prediction.length){
    alert("先に予想作成");
    return;
  }

  const text=document.getElementById("tData").value;
  const norm=normalize(text);

  if(!norm.ok){
    document.getElementById("result").innerHTML="<span class='ng'>検証失敗</span>";
    return;
  }

  const strong=[...norm.data].sort((a,b)=>b.diff-a.diff).slice(0,15);
  const strongSet=new Set(strong.map(x=>x.no));

  const hit=prediction.filter(p=>strongSet.has(p.no));
  const uniqueHit=[...new Set(hit.map(h=>h.no))];

  document.getElementById("result").innerHTML="<span class='ok'>検証OK</span>";
  document.getElementById("output").textContent=
    "命中数: "+uniqueHit.length+
    "\n命中台: "+(uniqueHit.join(",")||"なし");
}

</script>

</body>
</html>
