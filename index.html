<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>VEGAS 並び/単品 判定（strong日）</title>
<script src="jszip.min.js"></script>
<style>
body { font-family: monospace; background:#111; color:#eee; padding:20px; }
button { padding:10px 20px; font-size:16px; margin-top:10px; }
input { margin-top:10px; }
pre { background:#000; padding:15px; white-space:pre-wrap; }
</style>
</head>
<body>

<h2>VEGAS 並び/単品 判定（strong日）</h2>

<p>
strong（総差枚上位15%）の日だけを対象に、<br>
強台＝差枚3000以上（8台未満なら上位15から差枚1000以上で補完）で並び率を算出し、単品/混合/並びを判定します。<br>
※強台抽出は「全機種」対象（店の配置癖を見るため）。<br>
※桁区切りや異常値は自動補正します。
</p>

<input type="file" id="zipFile" accept=".zip">
<br>
<button onclick="analyzeZip()">解析開始</button>

<pre id="output"></pre>

<script>

async function analyzeZip() {
  const file = document.getElementById("zipFile").files[0];
  if (!file) {
    alert("ZIPファイルを選択してください");
    return;
  }

  const strongPercent = 15;
  const zip = await JSZip.loadAsync(file);
  const files = Object.keys(zip.files).filter(f => f.endsWith(".csv"));

  let daily = [];

  // ===============================
  // 安全な数値変換
  // ===============================
  function safeNumber(v) {
    if (!v) return 0;
    let s = String(v);

    // 桁区切り除去
    s = s.replace(/(\d),(?=\d{3}(\D|$))/g, "$1");

    // 数字とマイナスのみ残す
    s = s.replace(/[^0-9\-]/g, "");

    const n = parseInt(s, 10);
    if (isNaN(n)) return 0;

    // 異常値カット（±20000以上は壊れ）
    if (Math.abs(n) > 20000) return 0;

    return n;
  }

  for (let fname of files) {
    const text = await zip.files[fname].async("text");

    const delimiter = text.includes("\t") ? "\t" : ",";
    const lines = text.split("\n").filter(l => l.trim());

    if (lines.length < 2) continue;

    const header = lines[0].split(delimiter);

    const diffIndex = header.findIndex(h => h.includes("差枚"));
    const numIndex = header.findIndex(h => h.includes("台"));

    if (diffIndex < 0 || numIndex < 0) continue;

    let total = 0;
    let machines = [];

    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(delimiter);
      if (cols.length <= diffIndex) continue;

      const diff = safeNumber(cols[diffIndex]);
      const num = parseInt(cols[numIndex], 10);

      if (!isNaN(num)) {
        total += diff;
        machines.push({ num, diff });
      }
    }

    daily.push({
      date: fname.replace(".csv", ""),
      total,
      machines
    });
  }

  // ===============================
  // strong抽出（総差枚上位15%）
  // ===============================
  daily.sort((a, b) => b.total - a.total);

  const strongCount = Math.floor(daily.length * strongPercent / 100);
  const strongDays = daily.slice(0, strongCount);

  let result = "";
  result += "総日数: " + daily.length + "\n";
  result += "strong日数(15%): " + strongDays.length + "\n";
  result += "強台定義: 差枚>=3000（不足時補完あり）\n\n";

  function getStrongMachines(day) {
    let strong = day.machines.filter(m => m.diff >= 3000);

    if (strong.length < 8) {
      const sorted = [...day.machines]
        .sort((a, b) => b.diff - a.diff)
        .slice(0, 15)
        .filter(m => m.diff >= 1000);

      strong = sorted;
    }

    if (strong.length < 8) {
      strong = [...day.machines]
        .sort((a, b) => b.diff - a.diff)
        .slice(0, 8);
    }

    return strong;
  }

  let single = 0;
  let mix = 0;
  let line = 0;

  for (let day of strongDays) {

    const strong = getStrongMachines(day);

    if (strong.length === 0) continue;

    strong.sort((a, b) => a.num - b.num);

    let adjacent = 0;
    for (let i = 0; i < strong.length - 1; i++) {
      if (strong[i + 1].num === strong[i].num + 1) {
        adjacent++;
      }
    }

    const rate = (adjacent / strong.length) * 100;

    let type = "単品型";
    if (rate >= 40) {
      type = "並び型";
      line++;
    } else if (rate >= 20) {
      type = "混合型";
      mix++;
    } else {
      single++;
    }

    const maxDiff = Math.max(...strong.map(m => m.diff));

    result += `${day.date} | 強台数:${strong.length} | MAX差枚:${maxDiff} | 並び率:${rate.toFixed(1)}% | ${type}\n`;
  }

  result += "\n===== 総括 =====\n";
  result += `単品型: ${single}\n`;
  result += `混合型: ${mix}\n`;
  result += `並び型: ${line}\n`;

  document.getElementById("output").textContent = result;
}

</script>

</body>
</html>
