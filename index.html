<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>VEGAS 主力AT特化 予想ツール</title>
<style>
body{font-family:sans-serif;margin:20px}
button{padding:10px;margin:5px 0}
table{border-collapse:collapse;width:100%;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;font-size:12px}
.big{font-size:20px;font-weight:bold}
pre{background:#f5f5f5;padding:10px;white-space:pre-wrap}
.ok{color:#2e7d32;font-weight:bold}
.ng{color:#c62828;font-weight:bold}
</style>
</head>
<body>

<h2>VEGAS 主力AT特化 予想ツール</h2>

<p>前日CSV</p>
<input type="file" id="yFile" accept=".csv">
<button onclick="makePrediction()">予想作成</button>

<hr>

<p>当日CSV（検証用）</p>
<input type="file" id="tFile" accept=".csv">
<button onclick="evaluate()">検証</button>

<hr>

<div id="result" class="big"></div>
<div id="predOut"></div>
<pre id="debug"></pre>
<pre id="evalOut"></pre>

<script>

const MAIN_AT = [
"モンキーターンV",
"東京喰種",
"甲鉄城のカバネリ",
"スマスロ北斗の拳",
"新鬼武者"
];

let prediction = [];
let yesterdayData = [];

function parseCSV(text){
  text = text.replace(/^\uFEFF/, "").replace(/\r/g,"");
  const lines = text.split("\n").filter(l=>l.trim());
  const delim = text.includes("\t") ? "\t" : ",";
  const rows = lines.map(l=>l.replace(/"/g,"").split(delim));
  return rows;
}

function toNum(v){
  const s = String(v||"").replace(/,/g,"").trim();
  if(!s) return null;
  const n = Number(s);
  return Number.isFinite(n)?n:null;
}

function normalize(rows){
  const header = rows[0];
  const iMachine = header.findIndex(h=>h.includes("機種"));
  const iNo = header.findIndex(h=>h.includes("台"));
  const iG = header.findIndex(h=>h.includes("G"));
  const iDiff = header.findIndex(h=>h.includes("差"));

  document.getElementById("debug").textContent =
    "ヘッダー: "+header.join(" | ")+"\n"+
    "列位置 → 機種:"+iMachine+" 台:"+iNo+" G:"+iG+" 差枚:"+iDiff+"\n";

  if(iNo<0 || iDiff<0){
    return {ok:false};
  }

  const out=[];
  for(let i=1;i<rows.length;i++){
    const r = rows[i];
    const machine = r[iMachine];
    const no = toNum(r[iNo]);
    const g = iG>=0 ? (toNum(r[iG])??0) : 0;
    const diff = toNum(r[iDiff])??0;
    if(no==null) continue;
    out.push({machine,no,g,diff});
  }
  return {ok:true,data:out};
}

async function makePrediction(){

  const file = document.getElementById("yFile").files[0];
  if(!file){alert("前日CSVを選択");return;}

  const text = await file.text();
  const rows = parseCSV(text);
  const norm = normalize(rows);

  if(!norm.ok){
    document.getElementById("result").innerHTML="<span class='ng'>列検出失敗</span>";
    return;
  }

  yesterdayData = norm.data;

  const mainOnly = yesterdayData.filter(d=>
    MAIN_AT.some(at=>d.machine.includes(at))
  );

  const strongSet = new Set(
    mainOnly.filter(d=>d.diff>=3000).map(d=>d.no)
  );

  prediction = mainOnly.map(d=>{
    let score = 0;
    let reason = [];

    // 凹み高稼働最重視
    if(d.g>=3500 && d.diff<0){
      score += (d.g/1000)*6 + Math.min(20,Math.abs(d.diff)/500);
      reason.push("凹み高稼働");
    }

    // 隣接スライド
    if(strongSet.has(d.no-1)||strongSet.has(d.no+1)){
      score += 10;
      reason.push("隣接");
    }

    return {...d,score,reason:reason.join("/")};
  });

  prediction.sort((a,b)=>b.score-a.score);

  // 重複排除
  prediction = [...new Map(prediction.map(p=>[p.no,p])).values()].slice(0,15);

  renderPrediction();

  document.getElementById("result").innerHTML="<span class='ok'>予想OK</span>";
}

function renderPrediction(){
  let html="<table><tr><th>順位</th><th>台番号</th><th>機種</th><th>G</th><th>差枚</th><th>スコア</th><th>理由</th></tr>";
  prediction.forEach((p,i)=>{
    html+=`<tr>
      <td>${i+1}</td>
      <td>${p.no}</td>
      <td>${p.machine}</td>
      <td>${p.g}</td>
      <td>${p.diff}</td>
      <td>${p.score.toFixed(1)}</td>
      <td>${p.reason}</td>
    </tr>`;
  });
  html+="</table>";
  document.getElementById("predOut").innerHTML=html;
}

async function evaluate(){

  if(prediction.length===0){
    alert("先に予想作成");
    return;
  }

  const file = document.getElementById("tFile").files[0];
  if(!file){alert("当日CSVを選択");return;}

  const text = await file.text();
  const rows = parseCSV(text);
  const norm = normalize(rows);

  if(!norm.ok){
    document.getElementById("result").innerHTML="<span class='ng'>検証列エラー</span>";
    return;
  }

  const sorted = [...norm.data].sort((a,b)=>b.diff-a.diff);
  const strongSet = new Set(sorted.slice(0,15).map(d=>d.no));

  const hit = prediction.filter(p=>strongSet.has(p.no));
  const uniqueHit = [...new Set(hit.map(h=>h.no))];

  document.getElementById("evalOut").textContent =
    "命中数: "+uniqueHit.length+
    "\n命中台: "+(uniqueHit.join(",")||"なし");
}

</script>

</body>
</html>
