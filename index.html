<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>VEGAS 主軸4 単品傾向抽出</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
body{font-family:sans-serif;padding:15px}
button{padding:6px 12px;margin:5px 0}
input{width:70px}
#log{background:#111;color:#0f0;padding:10px;margin-top:10px;white-space:pre-wrap}
table{border-collapse:collapse;margin-top:10px}
td,th{border:1px solid #999;padding:4px}
</style>
</head>
<body>

<h2>VEGAS 主軸4 単品傾向抽出（strong × 機種内上位20%）</h2>

<input type="file" id="zipFile">
<br>
strong割合(%) <input type="number" id="strongPct" value="15">
上位割合(%) <input type="number" id="topPct" value="20">
表示件数 <input type="number" id="limit" value="30">
<br>
<button onclick="analyze()">解析開始</button>

<div id="log"></div>
<div id="result"></div>

<script>

const MAIN = ["スマスロ北斗","モンキーターン","甲鉄城","東京喰種"];

function cleanNumber(str){
  return Number(String(str).replace(/,/g,""))||0;
}

async function analyze(){

  const log = msg => document.getElementById("log").innerText += msg+"\n";
  document.getElementById("log").innerText="";
  document.getElementById("result").innerHTML="";

  const strongPct = Number(document.getElementById("strongPct").value)/100;
  const topPct = Number(document.getElementById("topPct").value)/100;
  const limit = Number(document.getElementById("limit").value);
  const file = document.getElementById("zipFile").files[0];
  if(!file){ alert("ZIPを選択してください"); return; }

  log("解析開始");

  const zip = await JSZip.loadAsync(file);
  let days=[];

  for(const name of Object.keys(zip.files)){
    if(!name.endsWith(".csv")) continue;
    const text = await zip.files[name].async("string");
    const lines = text.trim().split("\n");
    const header = lines[0].split(",");
    const idxMachine = header.findIndex(h=>h.includes("機種"));
    const idxNo = header.findIndex(h=>h.includes("台番"));
    const idxDiff = header.findIndex(h=>h.includes("差枚"));
    if(idxMachine<0||idxNo<0||idxDiff<0) continue;

    let total=0;
    let machines={};

    for(let i=1;i<lines.length;i++){
      const row = lines[i].split(",");
      const machine = row[idxMachine];
      const no = Number(row[idxNo]);
      const diff = cleanNumber(row[idxDiff]);
      total+=diff;

      if(MAIN.some(m=>machine.includes(m))){
        if(!machines[machine]) machines[machine]=[];
        machines[machine].push({no,diff});
      }
    }

    days.push({name,total,machines});
  }

  days.sort((a,b)=>b.total-a.total);
  const strongN = Math.floor(days.length*strongPct);
  const strongDays = days.slice(0,strongN);

  log("総日数: "+days.length);
  log("strong日数: "+strongDays.length);

  let machineStats={};

  for(const day of strongDays){
    for(const m of Object.keys(day.machines)){
      const arr = day.machines[m].sort((a,b)=>b.diff-a.diff);
      const take = Math.max(1,Math.floor(arr.length*topPct));
      const selected = arr.slice(0,take).filter(x=>x.diff>=3000);

      for(const s of selected){
        if(!machineStats[m]) machineStats[m]=[];
        machineStats[m].push(s.diff);
      }
    }
  }

  let resultArr=[];
  for(const m of Object.keys(machineStats)){
    const list = machineStats[m];
    const avg = list.reduce((a,b)=>a+b,0)/list.length;
    resultArr.push({machine:m,count:list.length,avg});
  }

  resultArr.sort((a,b)=>b.avg-a.avg);

  let html="<table><tr><th>機種</th><th>抽出台数</th><th>平均差枚</th></tr>";
  for(const r of resultArr.slice(0,limit)){
    html+=`<tr><td>${r.machine}</td><td>${r.count}</td><td>${Math.round(r.avg)}</td></tr>`;
  }
  html+="</table>";

  document.getElementById("result").innerHTML=html;

  log("完了");
}

</script>
</body>
</html>
