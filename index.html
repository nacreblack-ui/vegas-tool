<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>VEGAS AT単品／並び判定エンジン</title>
<style>
body{font-family:sans-serif;margin:20px}
button{padding:10px;margin:10px 0}
pre{background:#111;color:#0f0;padding:10px;font-size:12px;white-space:pre-wrap}
</style>
</head>
<body>

<h2>VEGAS AT単品／並び判定エンジン</h2>
<input type="file" id="zipFile" accept=".zip">
<br>
<button onclick="analyze()">解析開始</button>

<pre id="out"></pre>

<script src="jszip.min.js"></script>

const MAIN = [
"スマスロ北斗",
"モンキーターン",
"甲鉄城",
"東京喰種"
];

function parseCSV(text){
 text=text.replace(/\r/g,"").replace(/^\uFEFF/,"");
 const lines=text.split("\n").filter(l=>l.trim());
 const header=lines[0].split(",");
 const idxNo=header.findIndex(h=>h.includes("台"));
 const idxDiff=header.findIndex(h=>h.includes("差"));
 const idxMachine=header.findIndex(h=>h.includes("機種"));
 let data=[];
 for(let i=1;i<lines.length;i++){
   const row=lines[i].split(",");
   const no=parseInt(row[idxNo]);
   const diff=parseInt(row[idxDiff].replace(/,/g,""));
   const machine=row[idxMachine];
   if(isNaN(no)||isNaN(diff))continue;
   if(MAIN.some(m=>machine.includes(m))){
     data.push({no,diff});
   }
 }
 return data;
}

function stddev(arr){
 const avg=arr.reduce((a,b)=>a+b,0)/arr.length;
 const v=arr.reduce((a,b)=>a+(b-avg)**2,0)/arr.length;
 return Math.sqrt(v);
}

function classify(strongList){
 const sorted=[...strongList].sort((a,b)=>a-b);
 let adjacent=0;
 for(let i=0;i<sorted.length-1;i++){
   if(sorted[i+1]===sorted[i]+1)adjacent++;
 }
 const rate=adjacent/strongList.length;
 if(rate<0.15)return "単品型";
 if(rate<0.30)return "混合型";
 return "並び型";
}

async function analyze(){
 const file=document.getElementById("zipFile").files[0];
 if(!file){alert("ZIPを選択");return;}
 const zip=await JSZip.loadAsync(file);
 let results=[];
 let strongDays=[];
 
 for(const name in zip.files){
   if(!name.endsWith(".csv"))continue;
   const text=await zip.files[name].async("string");
   const data=parseCSV(text);
   if(data.length===0)continue;
   const total=data.reduce((a,b)=>a+b.diff,0);
   results.push({name,total,data});
 }
 
 results.sort((a,b)=>b.total-a.total);
 const strongCount=Math.floor(results.length*0.15);
 strongDays=results.slice(0,strongCount);
 
 let summary={単品型:0,混合型:0,並び型:0};
 let out="";
 
 strongDays.forEach(day=>{
   let strong=day.data.filter(d=>d.diff>=3000);
   if(strong.length<8){
     const fill=[...day.data]
       .filter(d=>d.diff>=1000)
       .sort((a,b)=>b.diff-a.diff);
     strong=fill.slice(0,8);
   }
   const nos=strong.map(d=>d.no);
   const type=classify(nos);
   summary[type]++;
   out+=`${day.name} | 強台数:${nos.length} | 型:${type}\n`;
 });
 
 out+="\n===== 総括 =====\n";
 const total=strongDays.length;
 Object.keys(summary).forEach(k=>{
   out+=`${k}: ${summary[k]}日 (${(summary[k]/total*100).toFixed(1)}%)\n`;
 });
 
 document.getElementById("out").textContent=out;
}

</script>
</body>
</html>

